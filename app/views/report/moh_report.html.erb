<style>
#table {
    font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
    border-collapse: collapse;

}

#table td, #table th {
    border: 1px solid #ddd;
    padding: 8px;
}

#table tr:nth-child(even){background-color: #f2f2f2;}

#table tbody tr:hover {background-color: #ddd;}

#table th {
    padding-top: 12px;
    padding-bottom: 12px;
    text-align: left;
    border-bottom: thin solid black;
   	color: white;   
	}
.sticky {
  position: fixed;
  top: 0;
 
}


</style>

	<div class="col-sm-10" style="margin-top: 30px;">
		
		<div class="col-sm-12">
			<div class="panel">
				<div class="panel-heading" style="color: black; font-weight: bold; border-bottom: thin solid black;">
					Searching Cretaria
				</div>
				<div class="panel-body">
					<span>
						<label>Level</label>
						<select name="level" id="level">
							<option value="national" onclick="document.getElementById('lab_facility').style.display ='none';">National Level</option>
							<option value="facility" onclick="document.getElementById('lab_facility').style.display ='inline';">Facility Level</option>
						</select>
					
					</span>
					<span id="lab_facility" style="margin-left: 10px; display: none;">
						<label>Lab</label>
						<select name="facility" id="facility">
							<option value="Kamuzu Central Hospital">Kamuzu Central Hospital Lab</option>
							<option value="Queen Elizabeth Central Hospital">Queens Elizabeth Hospital Lab</option>
							<option value="Thyolo District Hospital">Thyolo District Hospital Lab</option>
							<option value="Zomba Central Hospital">Zomba Central Hospital Lab</option>
							<option value="Mzuzu Central Hospital">Mzuzu Central Hospital Lab</option>
						</select>
					</span>
					<span style="margin-left: 10px;">
						<label>Lab Department</label>
						<select name="department" id="department">
							<option value="all">All Departments</option>
							<option value="Microbiology">Microbiology</option>
							<option value="Haematology">Haematology</option>
							<option value="Serology">Serology</option>
							<option value="Blood_Bank">Blood Bank</option>
							<option value="Biochemistry">Biochemistry</option>
							<option value="Parasitology">Parasitology</option>
						</select>
					</span>
					<span style="margin-left: 10px;">
						<label>Year</label>
						<select name="year" id="year">
							<option value="2018">2018</option>
							<option value="2017">2017</option>
							<option value="2016">2016</option>
						</select>
					</span>
					<span style="margin-left: 10px;">
						<label>Quarter</label>
						<select name="quarter" id="quarter">
							<option value="q1">Q1</option>
							<option value="q2">Q2</option>
							<option value="q3">Q3</option>
							<option value="q4">Q4</option>
						</select>
					</span>
					<span style="margin-left: 10px;">
						<input  class="btn btn-primary" type="button" value="Search" onclick="loadData();">
					</span>

					<span style="margin-left: 10px;">
						<input type="button" value="Export" class="btn btn-success" onclick="create_csv();">
					</span>

				</div>
			
			</div>
		</div>

		<div class="col-sm-12">
			
			<div style="margin-top: 1px; height: 650px;" id="table_data">
				<table class="table" id="table">
					<thead style="background-color: #37474F ;color: white; font-weight: bold;">
						<tr id="t_header">
							<th>Indicator</th>
				
						</tr>
					</thead>
					<tbody style="background-color: white; " id="rows">
							<tr id="disp_row">
								<td colspan="5">
									<span style="color: red;"> search to view data </span>
								</td>
								
							</tr>						
					</tbody>
				</table>
			</div>
		</div>

	</div>

</div>


<script type="text/javascript">
	


	var rows_counter = 0;
	var rows_header_counter = 0;
	var csv = [ ];

	function loadData() {

		var quarter = document.getElementById("quarter").value;
		var department = document.getElementById("department").value;
		var facility = document.getElementById("facility").value;
		var level = document.getElementById("level").value;
		var year = document.getElementById("year").value;
		var mainHeader = document.getElementById("t_header");
		var rows = document.getElementById("rows");
		var status = document.getElementById("status");
		var dis_row = document.getElementById("disp_row");
		var table = document.getElementById("table");


		var headerData = document.createElement("th");

		if (quarter == "q1")
		{   
			var cellCount = mainHeader.cells.length;
			
			if (cellCount == 5)
			{
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
			
			}
			else if (cellCount > 5)
			{
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
			}
				mainHeader.insertCell(1).innerHTML = "Total".bold();
				mainHeader.insertCell(1).innerHTML = "March".bold();
				mainHeader.insertCell(1).innerHTML = "Feb".bold();
				mainHeader.insertCell(1).innerHTML = "Jan".bold();
			

		} 
		else if (quarter == "q2")
		{
			var cellCount = mainHeader.cells.length;
			if (cellCount == 5)
			{
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
			
			}else if (cellCount > 5)
			{
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
			}

			mainHeader.insertCell(1).innerHTML = "Total".bold();
			mainHeader.insertCell(1).innerHTML = "Jun".bold();
			mainHeader.insertCell(1).innerHTML = "May".bold();
			mainHeader.insertCell(1).innerHTML = "Apr".bold();
			
		}
		else if (quarter == "q3")
		{	
			var cellCount = mainHeader.cells.length;
			if (cellCount == 5)
			{
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);			
			}else if (cellCount > 5)
			{
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
			}

			mainHeader.insertCell(1).innerHTML = "Total".bold();
			mainHeader.insertCell(1).innerHTML = "Sep".bold();
			mainHeader.insertCell(1).innerHTML = "Aug".bold();
			mainHeader.insertCell(1).innerHTML = "Jul".bold();
		}
		else if (quarter == "q4")
		{	
			var cellCount = mainHeader.cells.length;
			if (cellCount == 5)
			{
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);			
			}else if (cellCount > 5)
			{
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
			}

			mainHeader.insertCell(1).innerHTML = "Total".bold();
			mainHeader.insertCell(1).innerHTML = "Dec".bold();
			mainHeader.insertCell(1).innerHTML = "Nov".bold();
			mainHeader.insertCell(1).innerHTML = "Oct".bold();
		}
		else
		{
			var cellCount = mainHeader.cells.length;
			
			if (cellCount > 5)
			{
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);			
			}else if (cellCount ==5)
			{
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
				mainHeader.deleteCell(1);
			}

			mainHeader.insertCell(1).innerHTML = "Total"
			mainHeader.insertCell(1).innerHTML = "Dec"
			mainHeader.insertCell(1).innerHTML = "Nov"
			mainHeader.insertCell(1).innerHTML = "Oct"

			mainHeader.insertCell(1).innerHTML = "Total"
			mainHeader.insertCell(1).innerHTML = "Sep"
			mainHeader.insertCell(1).innerHTML = "Aug"
			mainHeader.insertCell(1).innerHTML = "Jul"

			mainHeader.insertCell(1).innerHTML = "Total"
			mainHeader.insertCell(1).innerHTML = "June"
			mainHeader.insertCell(1).innerHTML = "May"
			mainHeader.insertCell(1).innerHTML = "Apr"

			mainHeader.insertCell(1).innerHTML = "Total"
			mainHeader.insertCell(1).innerHTML = "March"
			mainHeader.insertCell(1).innerHTML = "Feb"
			mainHeader.insertCell(1).innerHTML = "Jan"
		}

	

		var header_counter = 0;
		var row_counter = 0;
		
		var com_counter = 0;
		
		var url = '/get_report?year=' + year + "&department=" + department + "&level=" + level + "&quarter=" + quarter + "&facility=" + facility;
		jQuery.ajax({
				async: false,
				url: url,
				success: function(res){
					var data = JSON.parse(res);
					if (rows_header_counter == 0){
						table.deleteRow(1);
					}
					else
					{	var v = rows_counter + rows_header_counter
						
						for (var r = 1; r <= v; v = v - 1)
						{ 
							table.deleteRow(r);
						}

						rows_counter = 0;
						rows_header_counter = 0;
					}
					csv = [];
					var c = 0
					for (var i in data){
						c = c + 1;
							var row = rows.insertRow(row_counter);
							var cel = row.insertCell(0);						
							cel.innerHTML = i.toUpperCase().bold();
							cel.style.color = "#007E33";
							cel.colSpan = "5";
							var department = i;
							row_counter = row_counter + 1;
							csv[com_counter] = [i,"","","",""];
							com_counter = com_counter + 1;
						for (var vl in data[department])
						{	var indicator = vl;
							var values = data[department][indicator].split("_");
							var row = rows.insertRow(row_counter);
							var cel = row.insertCell(0);
							var cel1 = row.insertCell(1);
							var cel2 = row.insertCell(2);
							var cel3 = row.insertCell(3);
							var cel4 = row.insertCell(4);						
							cel.innerHTML = indicator;
							cel1.innerHTML = values[0];
							cel2.innerHTML = values[1];
							cel3.innerHTML = values[2];
							cel4.innerHTML = parseInt(values[0]) + parseInt(values[1]) + parseInt(values[2]);
							row_counter = row_counter + 1;
							rows_counter = rows_counter + 1;
							csv[com_counter] = [indicator,values[0],values[1],values[2],parseInt(values[0]) + parseInt(values[1]) + parseInt(values[2])];
							com_counter = com_counter + 1;
						}	
						rows_header_counter  = rows_header_counter  + 1;
						console.log(c);							
					}

					document.getElementById("foot").style.display = "block";
					com_counter = 0;
					
				},	
				error: function(err){
					alert("bad");
				}
		})
	}



	function create_csv() {
		var months = [];
		var quarter = document.getElementById("quarter").value;
		if (quarter =="q1")
		{
			months[0] = ["JAN","FEB","MARCH"];
		}
		else if (quarter == "q2")
		{
			months[0] = ["APR","MAY","JUN"];
		}
		else if (quarter == "q3")
		{
			months[0] = ["JUL","AUG","SEP"];
		}
		else if (quarter == "q3")
		{
			months[0] = ["OCT","NOV","DEC"];
		}

		var final_csv ="Indicator" + "," + months[0][0] + "," + months[0][1] + "," + months[0][2] + ",TOTAL\n"
        var filename = "MoH_Data"    

        csv.forEach(function(row)
        {   final_csv += row.join(',');
            final_csv += "\n";
        });
        var link = document.createElement('a');
        if (typeof link.download === 'string')
        {   link.href = 'data:text/csv;charset=UTF-8,' + encodeURIComponent(final_csv);
            link.download = filename+".csv";
            document.body.appendChild(link);
            //simulate click
            link.click();
            //remove the link when done
            document.body.removeChild(link);
          } else 
          {window.open('data:text/csv;charset=UTF-8,' + encodeURIComponent(final_csv));
          }
 	}





 	window.onscroll = function() {myFunction()};

	// Get the header
	var header = document.getElementById("table_data");

	// Get the offset position of the navbar
	var sticky = header.offsetTop;

	// Add the sticky class to the header when you reach its scroll position. Remove "sticky" when you leave the scroll position
	function myFunction() {
	  if (window.pageYOffset > 155.51665954589844) {
	    header.classList.add("sticky");

	  } else {
	    header.classList.remove("sticky");
	  }
	} 




</script>